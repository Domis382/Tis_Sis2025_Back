generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////
// NUEVO: Tabla central de usuarios //
//////////////////////////////////////

model usuario {
  id_usuario   BigInt @id @default(autoincrement())
  nombre       String @db.VarChar(150)
  apellido     String @db.VarChar(150)
  correo       String @unique @db.VarChar(150)
  passwordHash String @db.VarChar(255)

  telefono        String?   @db.VarChar(50)
  fechaNacimiento DateTime?

  rol       rol_t
  estado    estado_usuario_t @default(ACTIVO)
  creado_en DateTime         @default(now())

  administrador    administrador?
  coordinador_area coordinador_area?
  responsable_area responsable_area?
  evaluador        evaluador?

  password_resets password_reset[]
  anuncioVistos   anuncio_visto[]
}

enum rol_t {
  ADMIN
  COORDINADOR
  RESPONSABLE
  EVALUADOR
  COMPETIDOR
}

enum estado_usuario_t {
  ACTIVO
  INACTIVO
}

////////////////////////////////////////
// NUEVO: Tabla para reset contraseña //
////////////////////////////////////////

model password_reset {
  id_reset  BigInt   @id @default(autoincrement())
  userId    BigInt
  code      String   @db.VarChar(6)
  expiresAt DateTime
  used      Boolean  @default(false)

  usuario usuario @relation(fields: [userId], references: [id_usuario])

  @@index([userId])
  @@index([code])
}

/////////////////////////////////////////////////
// MODELOS ORIGINALES (NO SE BORRA NADA)       //
// SOLO SE AGREGA id_usuario a los roles       //
/////////////////////////////////////////////////

model administrador {
  id_administrador BigInt @id @default(autoincrement())

  // AHORA OPCIONAL
  id_usuario BigInt?  @unique
  usuario    usuario? @relation(fields: [id_usuario], references: [id_usuario])

  nombre_admin        String               @db.VarChar(100)
  apellido_admin      String               @db.VarChar(100)
  correo_admin        String               @unique @db.VarChar(150)
  estado              estado_admin_t       @default(ACTIVO)
  fecha_registro      DateTime             @default(now()) @db.Timestamp(6)
  id_area             BigInt?
  id_coordinador      BigInt?
  id_parametro        BigInt?
  id_listas           BigInt?
  id_auditoria        BigInt?
  id_usuario          BigInt?              @unique
  area                area?                @relation(fields: [id_area], references: [id_area])
  coordinador_area    coordinador_area?    @relation(fields: [id_coordinador], references: [id_coordinador])
  listas_publicadas   listas_publicadas?   @relation(fields: [id_listas], references: [id_listas])
  parametro_medallero parametro_medallero? @relation(fields: [id_parametro], references: [id_parametro])
  usuario             usuario?             @relation(fields: [id_usuario], references: [id_usuario])
  auditoria           auditoria?           @relation(fields: [id_auditoria], references: [id_auditoria], map: "fk_admin_auditoria")
  anuncios            anuncio[]
}

model area {
  id_area             BigInt               @id @default(autoincrement())
  nombre_area         String               @unique @db.VarChar(100)
  administrador       administrador[]
  anuncios            anuncio[]
  coordinador_area    coordinador_area[]
  evaluador           evaluador[]
  inscritos           inscritos[]
  listas_publicadas   listas_publicadas[]
  parametro_medallero parametro_medallero?
  responsable_area    responsable_area[]
  anuncios            anuncio[]
}

model auditoria {
  id_auditoria          BigInt            @id @default(autoincrement())
  fecha_hora            DateTime          @default(now()) @db.Timestamp(6)
  actor_tipo            actor_tipo_t
  id_actor              BigInt?
  actor_nombre_snapshot String?           @db.VarChar(200)
  accion                String            @db.VarChar(100)
  entidad               String            @db.VarChar(100)
  id_entidad            BigInt?
  valor_anterior        String?
  valor_nuevo           String?
  resultado             resultado_audit_t @default(OK)
  motivo_error          String?
  administrador         administrador[]

  @@index([actor_tipo, id_actor], map: "ix_auditoria_actor")
  @@index([entidad, id_entidad], map: "ix_auditoria_entidad")
  @@index([fecha_hora], map: "ix_auditoria_fecha")
}

model clasificados {
  id_clasificado BigInt               @id @default(autoincrement())
  id_inscrito    BigInt
  id_fase        BigInt
  estado         estado_clasificado_t
  fases          fases                @relation(fields: [id_fase], references: [id_fases])
  inscritos      inscritos            @relation(fields: [id_inscrito], references: [id_inscritos], onDelete: Cascade)

  @@unique([id_inscrito, id_fase], map: "uq_clasif_unica")
  @@index([id_fase], map: "ix_clasif_fase")
}

model coordinador_area {
  id_coordinador BigInt @id @default(autoincrement())

  id_usuario BigInt?  @unique
  usuario    usuario? @relation(fields: [id_usuario], references: [id_usuario])

  nombre_coordinador    String          @db.VarChar(100)
  apellidos_coordinador String          @db.VarChar(100)
  id_area               BigInt
  carnet                String?         @db.VarChar(50)
  correo_electronico    String?         @unique
  pass_coordinador      String?
  telefono              String?         @db.VarChar(50)
  usuario_coordinador   String?         @unique
  id_usuario            BigInt?         @unique
  administrador         administrador[]
  area                  area            @relation(fields: [id_area], references: [id_area])
  usuario               usuario?        @relation(fields: [id_usuario], references: [id_usuario])
  importaciones         importaciones[]
}

model evaluaciones {
  id_evaluacion BigInt    @id @default(autoincrement())
  id_inscrito   BigInt
  id_evaluador  BigInt
  id_fase       BigInt
  nota          Decimal?  @db.Decimal(6, 2)
  observacion   String?
  fecha         DateTime  @default(now()) @db.Timestamp(6)
  evaluador     evaluador @relation(fields: [id_evaluador], references: [id_evaluador])
  fases         fases     @relation(fields: [id_fase], references: [id_fases])
  inscritos     inscritos @relation(fields: [id_inscrito], references: [id_inscritos], onDelete: Cascade)

  @@unique([id_inscrito, id_evaluador, id_fase], map: "uq_eval_unica")
  @@index([id_evaluador], map: "ix_eval_evaluador")
  @@index([id_inscrito, id_fase], map: "ix_eval_inscrito_fase")
}

model evaluador {
  id_evaluador BigInt @id @default(autoincrement())

  id_usuario BigInt?  @unique
  usuario    usuario? @relation(fields: [id_usuario], references: [id_usuario])

  nombre_evaluado     String         @db.VarChar(100)
  apellidos_evaluador String         @db.VarChar(100)
  id_area             BigInt
  id_usuario          BigInt?        @unique
  evaluaciones        evaluaciones[]
  area                area           @relation(fields: [id_area], references: [id_area])
  usuario             usuario?       @relation(fields: [id_usuario], references: [id_usuario])
}

model fases {
  id_fases          BigInt              @id @default(autoincrement())
  nombre_fase       String              @unique @db.VarChar(50)
  descripcion       String?             @db.VarChar(255)
  clasificados      clasificados[]
  evaluaciones      evaluaciones[]
  listas_publicadas listas_publicadas[]
}

model importaciones {
  id_import        BigInt           @id @default(autoincrement())
  id_coordinador   BigInt
  fecha_hora       DateTime         @default(now()) @db.Timestamp(6)
  nombre_archivo   String           @db.VarChar(255)
  total_registro   Int              @default(0)
  total_ok         Int              @default(0)
  total_error      Int              @default(0)
  detalle_errores  String?
  coordinador_area coordinador_area @relation(fields: [id_coordinador], references: [id_coordinador])
  inscritos        inscritos[]

  @@index([id_coordinador, fecha_hora], map: "ix_import_coord_fecha")
}

model inscritos {
  id_inscritos       BigInt               @id @default(autoincrement())
  nombres_inscrito   String               @db.VarChar(100)
  apellidos_inscrito String               @db.VarChar(100)
  ci_inscrito        String?              @db.VarChar(40)
  id_nivel           BigInt
  id_area            BigInt
  estado             estado_inscripcion_t @default(ACTIVA)
  id_import          BigInt?
  colegio            String?              @db.VarChar(150)
  contacto_tutor     String?              @db.VarChar(50)
  unidad_educativa   String?              @db.VarChar(150)
  departamento       String?              @db.VarChar(50)
  grado_escolaridad  String?              @db.VarChar(50)
  tutor_academico    String?              @db.VarChar(150)
  clasificados       clasificados[]
  evaluaciones       evaluaciones[]
  area               area                 @relation(fields: [id_area], references: [id_area])
  importaciones      importaciones?       @relation(fields: [id_import], references: [id_import])
  nivel              nivel                @relation(fields: [id_nivel], references: [id_nivel])

  @@index([id_area, id_nivel], map: "ix_inscritos_area_nivel")
}

model listas_publicadas {
  id_listas     BigInt          @id @default(autoincrement())
  id_fase       BigInt
  id_area       BigInt
  tipolista     tipo_lista_t
  fecha_publica DateTime        @default(now()) @db.Timestamp(6)
  administrador administrador[]
  area          area            @relation(fields: [id_area], references: [id_area])
  fases         fases           @relation(fields: [id_fase], references: [id_fases])

  @@index([id_area, id_fase], map: "ix_listas_area_fase")
}

model nivel {
  id_nivel     BigInt      @id @default(autoincrement())
  nombre_nivel String      @unique @db.VarChar(100)
  inscritos    inscritos[]
}

model parametro_medallero {
  id_parametro     BigInt          @id @default(autoincrement())
  id_area          BigInt          @unique
  cantidad_oros    Int             @default(1)
  cantidad_platas  Int             @default(1)
  cantidad_bronces Int             @default(1)
  menciones        Int             @default(0)
  administrador    administrador[]
  area             area            @relation(fields: [id_area], references: [id_area])
}

model responsable_area {
  id_responsable BigInt @id @default(autoincrement())

  id_usuario BigInt?  @unique
  usuario    usuario? @relation(fields: [id_usuario], references: [id_usuario])

  nombres_evaluador  String @db.VarChar(100)
  apellidos          String @db.VarChar(100)
  correo_electronico String @unique @db.VarChar(150)
  id_area            BigInt
  area               area   @relation(fields: [id_area], references: [id_area])
}

//////////////////////////
// ENUMS ORIGINALES     //
//////////////////////////

enum actor_tipo_t {
  ADMINISTRADOR
  COORDINADOR
  RESPONSABLE_AREA
  EVALUADOR
  SISTEMA
}

enum estado_admin_t {
  ACTIVO
  INACTIVO
}

enum estado_clasificado_t {
  CLASIFICADO
  NO_CLASIFICADO
  DESCLASIFICADO
}

enum estado_inscripcion_t {
  ACTIVA
  DESCLASIFICADA
}

enum resultado_audit_t {
  OK
  ERROR
}

enum tipo_lista_t {
  CERTIFICADOS
  CEREMONIA
  PUBLICACION
}

////////////////////////////////////////
// SISTEMA DE ANUNCIOS - NUEVO MODELO //
////////////////////////////////////////

model anuncio {
  id_anuncio     BigInt           @id @default(autoincrement())
  titulo         String           @db.VarChar(200)
  contenido      String           @db.Text
  tipo_anuncio   tipo_anuncio_t   @default(GENERAL)
  estado_anuncio estado_anuncio_t @default(ACTIVO)

  fecha_publicacion DateTime? @db.Timestamp(6)
  fecha_expiracion  DateTime? @db.Timestamp(6)

  // Relación con el administrador que crea el anuncio
  id_administrador BigInt?
  administrador    administrador? @relation(fields: [id_administrador], references: [id_administrador])

  // Campos para imágenes/destacados
  imagen_url   String? @db.VarChar(500)
  imagen_alt   String? @db.VarChar(200)
  es_destacado Boolean @default(false)
  orden        Int     @default(0)

  // Auditoría
  creado_en      DateTime @default(now()) @db.Timestamp(6)
  actualizado_en DateTime @default(now()) @db.Timestamp(6)

  // Relación con áreas específicas (si el anuncio es para un área en particular)
  id_area BigInt?
  area    area?   @relation(fields: [id_area], references: [id_area])

  // Relación con archivos adjuntos
  archivos_anuncio archivo_anuncio[]
  anuncioVistos    anuncio_visto[]

  @@index([estado_anuncio])
  @@index([tipo_anuncio])
  @@index([fecha_publicacion])
  @@index([es_destacado])
  @@index([id_area])
}

model archivo_anuncio {
  id_archivo     BigInt  @id @default(autoincrement())
  id_anuncio     BigInt
  nombre_archivo String  @db.VarChar(255)
  url_archivo    String  @db.VarChar(500)
  tipo_archivo   String  @db.VarChar(100) // 'imagen', 'pdf', 'documento', etc.
  tamaño        BigInt? // en bytes
  orden          Int     @default(0)

  anuncio anuncio @relation(fields: [id_anuncio], references: [id_anuncio], onDelete: Cascade)

  creado_en DateTime @default(now()) @db.Timestamp(6)

  @@index([id_anuncio])
  @@index([tipo_archivo])
}

model anuncio_visto {
  id_visto   BigInt   @id @default(autoincrement())
  id_anuncio BigInt
  id_usuario BigInt
  visto_en   DateTime @default(now()) @db.Timestamp(6)

  anuncio anuncio @relation(fields: [id_anuncio], references: [id_anuncio], onDelete: Cascade)
  usuario usuario @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@unique([id_anuncio, id_usuario], map: "uq_anuncio_visto_unico")
  @@index([id_usuario])
  @@index([id_anuncio])
}

//////////////////////////
// ENUMS PARA ANUNCIOS  //
//////////////////////////

enum tipo_anuncio_t {
  GENERAL
  URGENTE
  IMPORTANTE
  EVENTO
  NOTICIA
  SISTEMA
}

enum estado_anuncio_t {
  BORRADOR
  ACTIVO
  INACTIVO
  EXPIRADO
}
